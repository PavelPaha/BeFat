@page "/"

@inherits LayoutComponentBase
@using Microsoft.EntityFrameworkCore
@using Microsoft.Extensions.Configuration
@using Microsoft.Extensions.DependencyInjection
@using Microsoft.Extensions.Options
@using BeeFat.Data
@using BeeFat.Domain.Infrastructure
@using System.Globalization


@{
    var days = new Dictionary<int, string>()
    {
        { 1, "Понедельник" },
        { 2, "Вторник" },
        { 3, "Среда" },
        { 4, "Четверг" },
        { 5, "Пятница" },
        { 6, "Суббота" },
        { 0, "Воскресенье" }
    };

    
    var configuration = new ConfigurationBuilder()
        .AddJsonFile("appsettings.json")
        .Build();
    
    var options = new DbContextOptionsBuilder<ApplicationDbContext>()
        .UseNpgsql(configuration.GetConnectionString("DefaultConnection"))
        .Options;
}

<PageTitle>Home</PageTitle>

<div class="container">
    <!-- Левая колонка -->
    <div class="home-sidebar">
        <h2>Имя трека</h2>
        <ul>
            <li><button>Редактировать трек</button></li>
            <li><button>Изменить параметры тела</button></li>
            <li><button>Калибровка</button></li>
        </ul>
    </div>

    <!-- Средняя колонка -->
    <div class="main-content">
        <div class="daily-plan">
             <ul class="daily-food-list product-list">
                <h2>План питания на сегодня</h2>
                 @{
                    var today = DayOfWeek.Monday;
                    using (var context = new FakeApplicationDbContext())
                    {
                        var todayDailyPlan = context.FoodProducts.Where(p => p.DayOfWeek.Equals(today));
                        foreach (var product in todayDailyPlan)
                        {
                            <li>
                                <input type="checkbox">
                                <div class="product">
                                    <span class="product-name">@product.Name</span>
                                    <span class="portion-size">@String.Format("{0} {1}", product.PortionSize, (product is FoodProductGram) ? "грамм" : "шт")</span>
                                    @* @if (product is FoodProductGram) "грамм"; *@
                                    @* else "шт";: *@
                                </div>
                            </li>
                        }
                    }
                }
            </ul>
        </div>
        <div class="next-days-plan product-list">
            <h3>План питания на следующие дни</h3>
            <ul>
                @{
                    using (var context = new FakeApplicationDbContext())
                    {
                        var todayNumber = (int)today;
                        for (int dayNumber = todayNumber + 1; dayNumber <= 6 && dayNumber < todayNumber + 3; dayNumber++)
                        {
                            var products = context.FoodProducts.Where(p => (int)p.DayOfWeek == dayNumber);
                            if (!products.Any()) break;
                            <li>
                                <div class="product">
                                    @{
                                        <span class="product-name">
                                            @{
                                                <span>@days[dayNumber]: </span>
                                                var takenProducts = products.Take(4).ToList();
                                                for (var i = 0; i < takenProducts.Count; i++)
                                                {
                                                    var product = takenProducts[i];
                                                    @product.Name;
                                                    if (i != takenProducts.Count - 1)
                                                    {
                                                        <span>, </span>
                                                    }
                                                }

                                                if (products.Count() > 4)
                                                {
                                                    <span>...</span>
                                                }
                                            }
                                        </span>
                                    }
                                </div>
                            </li>
                        }
                    }
                }
            </ul>
        </div>
    </div>

    <!-- Правая колонка -->
    <div class="home-sidebar">
        <div class="user-info">
            <img src="avatar.jpg">
            <span class="username">@{
                using (var context = new ApplicationDbContext(options, configuration))
                {
                    var user = context.BeeFatUsers.FirstOrDefault();
                    @user.UserName.ToString()
                }
            }</span>
        </div>
        <div class="parameters">
            <h3>Параметры</h3>
            <p>Масса: <span>xxx кг</span></p>
            <p>Рост: <span>xxx см</span></p>
            <p>Желаемые калории: <span>xxx ккал</span></p>
        </div>
    </div>
</div>